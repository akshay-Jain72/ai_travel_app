<!DOCTYPE html>
<html>
<head>
    <title>üìä Akshay Travels Analytics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
          text-align: center;
          color: white;
          margin-bottom: 40px;
          text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .input-group {
          background: rgba(255,255,255,0.95);
          padding: 20px;
          border-radius: 16px;
          margin-bottom: 30px;
          display: flex;
          gap: 15px;
          max-width: 600px;
          margin-left: auto;
          margin-right: auto;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .token-input {
          flex: 1;
          padding: 14px 18px;
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          font-size: 16px;
          transition: all 0.3s;
        }
        .token-input:focus {
          outline: none;
          border-color: #2563eb;
          box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .load-btn {
          background: linear-gradient(45deg, #2563eb, #1d4ed8);
          color: white;
          border: none;
          padding: 14px 28px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 4px 15px rgba(37,99,235,0.4);
        }
        .load-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37,99,235,0.5); }
        .grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 25px;
        }
        .card {
          background: rgba(255,255,255,0.95);
          padding: 30px;
          border-radius: 20px;
          box-shadow: 0 15px 35px rgba(0,0,0,0.1);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
          transition: all 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .metric {
          font-size: 3.2em;
          font-weight: 800;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        .metric-value {
          font-size: 0.6em;
          font-weight: 900;
          min-width: 2.5em;
          text-align: center;
        }
        .label {
          color: #64748b;
          font-size: 1.1em;
          font-weight: 500;
          margin-top: 5px;
        }
        .loading { text-align: center; color: white; font-size: 1.2em; }
        .error {
          background: #fee2e2;
          color: #dc2626;
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          border-left: 4px solid #ef4444;
        }
        .debug-info {
          background: rgba(0,0,0,0.2);
          color: white;
          padding: 15px;
          border-radius: 12px;
          margin: 20px 0;
          font-family: monospace;
          font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä Akshay Travels Analytics Dashboard</h1>
        <p>Real-time metrics ‚Ä¢ Powered by MongoDB + Node.js</p>
    </div>

    <div class="input-group">
        <input type="password" id="tokenInput" class="token-input" placeholder="üîë Enter JWT Token (from Flutter login console)" />
        <button class="load-btn" onclick="loadAnalytics()">üöÄ Load Analytics</button>
    </div>

    <div id="loading" class="loading" style="display: none;">‚è≥ Loading real-time analytics...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="debug" class="debug-info" style="display: none;"></div>
    <div id="metrics" class="grid"></div>
</div>

<script>
    async function loadAnalytics() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        alert('‚ö†Ô∏è Please enter your JWT token first!');
        return;
      }

      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const debugEl = document.getElementById('debug');
      const metricsEl = document.getElementById('metrics');

      // Reset UI
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      debugEl.style.display = 'none';
      metricsEl.innerHTML = '';

      try {
        console.log('üîÑ Fetching /api/analytics with token:', token.substring(0, 20) + '...');

        const res = await fetch('/api/analytics', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        console.log('üìä Raw API Response:', data);

        if (!data.status) {
          throw new Error(data.message || 'API returned error');
        }

        // Debug info
        debugEl.innerHTML = `
          <strong>‚úÖ API Success!</strong><br>
          Total keys: ${Object.keys(data.data || {}).length}<br>
          Data sample: ${JSON.stringify(data.data, null, 2).substring(0, 200)}...
        `;
        debugEl.style.display = 'block';

        const metrics = [
          { label: 'Total Itineraries', key: 'totalItineraries', icon: 'üìã', color: '#3b82f6' },
          { label: 'Total Travelers', key: 'totalTravelers', icon: 'üë•', color: '#10b981' },
          { label: 'WhatsApp Messages', key: 'whatsappSent', icon: 'üì±', color: '#f59e0b' },
          { label: 'Active Trips', key: 'activeTrips', icon: '‚úàÔ∏è', color: '#ef4444' },
          { label: 'AI Chat Queries', key: 'chatQueries', icon: 'ü§ñ', color: '#8b5cf6' },
          { label: 'Success Rate', key: 'successRate', icon: '‚úÖ', color: '#059669' }
        ];

        // ‚úÖ FIXED: Safe data access + formatting
        metricsEl.innerHTML = metrics.map(m => {
          const value = data.data?.[m.key];
          const displayValue = value !== undefined && value !== null ? value : '0';

          return `
            <div class="card">
              <div class="metric" style="color: ${m.color}">
                ${m.icon}
                <span class="metric-value">${displayValue}</span>
              </div>
              <div class="label">${m.label}</div>
            </div>
          `;
        }).join('');

        loadingEl.style.display = 'none';

      } catch (err) {
        console.error('‚ùå Analytics Error:', err);
        loadingEl.style.display = 'none';
        errorEl.innerHTML = `
          <strong>‚ùå Error:</strong> ${err.message}<br>
          <small>üí° Check browser console (F12) ‚Üí Network tab ‚Üí /api/analytics response</small>
        `;
        errorEl.style.display = 'block';
      }
    }

    // Enter key support
    document.getElementById('tokenInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadAnalytics();
      }
    });

    // Auto-focus input
    document.getElementById('tokenInput').focus();
</script>
</body>
</html>
